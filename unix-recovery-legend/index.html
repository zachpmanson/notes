<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="/static/styles/global.css" />
  <link rel="stylesheet" href="/static/styles/code.css" />

  <link rel="icon" href="/static/icon/icon.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="/static/icon/favicon.ico" />

  <link rel="alternate" type="application/rss+xml" href="https://notes.zachmanson.com/posts.xml" title="notes: posts" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>notes: unix recovery legend</title>
</head>

<body>
  <nav>
    <div class="main-icon">
      <a href="/">
        <svg xmlns="http://www.w3.org/2000/svg" baseProfile="full" version="1.1" style="fill: none;"
          viewBox="26.88 56.87 216.25 156.27">
          <path
            style="stroke-width: 15px; stroke-linecap: butt; stroke-linejoin: round; stroke: rgb(10, 10, 10); fill: none;"
            d="M135,75 A60,60 0 0,0 75,135 A60,60 0 0,0 135,195 A60,60 0 0,0 195,135 A60,60 0 0,0 135,75 M45,90 A15,15 0 0,1 60,75 A15,15 0 0,1 75,90 L75,135 L75,180 A15,15 0 0,1 60,195 A15,15 0 0,1 45,180 M225,90 A15,15 0 0,0 210,75 A15,15 0 0,0 195,90 L195,135 L195,180 A15,15 0 0,0 210,195 L210,195 A15,15 0 0,0 225,180 M135,105 A30,30 0 0,1 165,135 A30,30 0 0,1 135,165 A30,30 0 0,1 105,135 A30,30 0 0,1 135,105 M45,105 L45,105 L45,165 M225,105 L225,105 L225,165 ">
          </path>
        </svg>
      </a>
    </div>

    <div class="nav-segments-container">
      <div class="nav-segments">
        

        <div class="flex flex-col text-left nav-links">
          <a href="/folklore" class="activated-link">Folklore</a>
          
          
          <a href="/bookmarks">Bookmarks</a>
          
          
          
          <a href="/fiction">Fiction</a>
          
          
          
          
          
          
          <a href="/lines">Lines</a>
          
          
          
          <a href="/problems">Problems</a>
          
          
          
          <a href="/templates">Templates</a>
          
          
        </div>
        

        

        <div class="flex flex-col text-left nav-links">
          <a href="/unix-recovery-legend" class="activated-link">Unix Recovery Legend</a>
          
          
          <a href="/10-rules-of-internet">10 Rules of Internet</a>
          
          
          
          <a href="/a-conspiracy-to-kill-ie6">A Conspiracy To Kill IE6</a>
          
          
          
          <a href="/a-story-about-magic">A Story About 'Magic'</a>
          
          
          
          <a href="/alice-in-modeland">Alice in Modeland</a>
          
          
          
          <a href="/aliens-and-calendars">Aliens and Calendars</a>
          
          
          
          <a href="/amazons-first-job-posting">Amazon's First Job Posting</a>
          
          
          
          <a href="/an-update-on-facebook-video-marketing-metrics">An Update on Facebook Video Marketing Metrics</a>
          
          
          
          <a href="/bell-labs-productivity-mystery">Bell Labs' Productivity Mystery</a>
          
          
          
          <a href="/best-practices-for-time-travellers">Best Practices for Time Travellers</a>
          
          
          
          <a href="/bill-gates-tries-to-install-windows-movie-maker">Bill Gates Tries To Install Windows Movie Maker</a>
          
          
          
          <a href="/bill-gates-wrote-fat-on-an-airplane">Bill Gates Wrote FAT on an Airplane</a>
          
          
          
          <a href="/blinkenlichten">Blinkenlichten</a>
          
          
          
          <a href="/c-locale-braindeath">C Locale Braindeath</a>
          
          
          
          <a href="/cannot-simultaneously-fix-and-keep-job.-therefore-wont-fix.">Cannot simultaneously fix and keep job. Therefore, won't fix.</a>
          
          
          
          <a href="/christ-mcdonald">Christ McDonald</a>
          
          
          
          <a href="/competing-with-gpt">Competing with GPT</a>
          
          
          
          <a href="/context-menu-hell">Context Menu Hell</a>
          
          
          
          <a href="/digg-v4">Digg v4</a>
          
          
          
          <a href="/dispatch-from-the-cyberpunk-city">Dispatch From the Cyberpunk City</a>
          
          
          
          <a href="/do-things-tell-people">Do Things, Tell People</a>
          
          
          
          <a href="/ellsbergs-advice-for-kissinger">Ellsberg's Advice For Kissinger</a>
          
          
          
          <a href="/facing-the-street">Facing the Street</a>
          
          
          
          <a href="/factory-factory-factory">Factory Factory Factory</a>
          
          
          
          <a href="/feminist-server-manifesto">Feminist Server Manifesto</a>
          
          
          
          <a href="/file-over-app">File Over App</a>
          
          
          
          <a href="/git-koans">Git Koans</a>
          
          
          
          <a href="/growth-at-tumblr-and-wordpress">Growth at Tumblr and Wordpress</a>
          
          
          
          <a href="/guerilla-open-access-manifesto">Guerilla Open Access Manifesto</a>
          
          
          
          <a href="/heaven-banning">Heaven Banning</a>
          
          
          
          <a href="/i-no-longer-built-software">I No Longer Built Software</a>
          
          
          
          <a href="/incomplete-list-of-mistakes-in-the-design-of-css">Incomplete List of Mistakes in the Design of CSS</a>
          
          
          
          <a href="/interviewing-for-canonical">Interviewing for Canonical</a>
          
          
          
          <a href="/jsx-react-native-and-typescript">JSX, React Native, and TypeScript</a>
          
          
          
          <a href="/kurt-vonnegut-grades">Kurt Vonnegut Grades</a>
          
          
          
          <a href="/larry-page-builds-a-web-robot">Larry Page Builds a Web Robot</a>
          
          
          
          <a href="/life-of-an-oracle-developer">Life of an Oracle Developer</a>
          
          
          
          <a href="/man-spends-entire-career-mastering-crappy-codebase">Man Spends Entire Career Mastering Crappy Codebase</a>
          
          
          
          <a href="/no-coffee-==-no-job">No Coffee == No Job</a>
          
          
          
          <a href="/no-dogs-were-harmed-in-the-making-of-this-app">No dogs were harmed in the making of this app</a>
          
          
          
          <a href="/not-a-real-engineer">Not a real engineer</a>
          
          
          
          <a href="/on-the-origin-of-emacs">On the Origin of Emacs</a>
          
          
          
          <a href="/on-the-origin-of-toots">On the Origin of Toots</a>
          
          
          
          <a href="/openoffice-cant-print-on-tuesdays">OpenOffice Can't Print on Tuesdays</a>
          
          
          
          <a href="/oracle-as-lawnmower">Oracle as Lawnmower</a>
          
          
          
          <a href="/originality-not-required">Originality Not Required</a>
          
          
          
          <a href="/psd-is-not-my-favourite-file-format">PSD is not my favourite file format</a>
          
          
          
          <a href="/please-drink-verification-can">Please Drink Verification Can</a>
          
          
          
          <a href="/pocket-veto">Pocket Veto</a>
          
          
          
          <a href="/price-of-chatgpts-api-vs-human">Price of ChatGPT's API vs Human</a>
          
          
          
          <a href="/put-yourself-in-jia-tans-shoes">Put yourself in Jia Tan's shoes</a>
          
          
          
          <a href="/regular-expressions-and-html">Regular Expressions and HTML</a>
          
          
          
          <a href="/rob-pikes-5-rules-of-programming">Rob Pike's 5 Rules of Programming</a>
          
          
          
          <a href="/rob-pikes-lesson-in-shortcuts">Rob Pike's Lesson in Shortcuts</a>
          
          
          
          <a href="/sre-threats">SRE Threats</a>
          
          
          
          <a href="/steve-yegges-tale-of-geoworks">Steve Yegge's Tale of Geoworks</a>
          
          
          
          <a href="/steveys-google-platforms-rant">Stevey's Google Platforms Rant</a>
          
          
          
          <a href="/superstitious-encoding">Superstitious Encoding</a>
          
          
          
          <a href="/the-bitter-lesson">The Bitter Lesson</a>
          
          
          
          <a href="/the-cab-ride-ill-never-forget">The Cab Ride I'll Never Forget</a>
          
          
          
          <a href="/the-case-of-the-500-mile-email">The Case of the 500-Mile Email</a>
          
          
          
          <a href="/the-crawford-principles">The Crawford Principles</a>
          
          
          
          <a href="/the-damned-can-now-play-three-chords">The Damned Can Now Play Three Chords</a>
          
          
          
          <a href="/the-future-of-open-source">The Future of Open Source</a>
          
          
          
          <a href="/the-nazi-bar-problem">The Nazi Bar Problem</a>
          
          
          
          <a href="/the-patron-saint-of-yak-shaves">The Patron Saint of Yak Shaves</a>
          
          
          
          <a href="/the-reddit-long-con">The Reddit Long Con</a>
          
          
          
          <a href="/the-smallest-quine">The Smallest Quine</a>
          
          
          
          <a href="/the-unknown-citizen">The Unknown Citizen</a>
          
          
          
          <a href="/the-bin-split">The bin Split</a>
          
          
          
          <a href="/thoughts-on-flash">Thoughts On Flash</a>
          
          
          
          <a href="/tiktoks-enshittification">TikTok's Enshittification</a>
          
          
          
          <a href="/time-traveller-on-irc">Time Traveller on IRC</a>
          
          
          
          
          
          
          <a href="/usenet-post-warning">Usenet Post Warning</a>
          
          
          
          <a href="/virtues-of-a-good-programmer">Virtues of a Good Programmer</a>
          
          
          
          <a href="/we-do-not-break-userspace">We Do Not Break Userspace</a>
          
          
          
          <a href="/we-have-no-moat-and-neither-does-openai">We Have No Moat, And Neither Does OpenAI</a>
          
          
          
          <a href="/when-is-midnight">When Is Midnight</a>
          
          
          
          <a href="/wikipedia-and-anti-elitism">Wikipedia and Anti-Elitism</a>
          
          
          
          <a href="/worse-is-better">Worse is Better</a>
          
          
          
          <a href="/yak-shaving">Yak Shaving</a>
          
          
          
          <a href="/carproblems.txt">carproblems.txt</a>
          
          
        </div>
        

        
      </div>
    </div>
  </nav>

  <main>
    <header>
      <h1>Unix Recovery Legend</h1>
    </header>

    <article><p>This classic article from Mario Wolczko first appeared on Usenet in 1986.</p>
<hr />
<p>Have you ever left your terminal logged in, only to find when you came back to it that a (supposed) friend had typed "<code>rm -rf ~/*</code>" and was hovering over the keyboard with threats along the lines of "<em>lend me a fiver 'til Thursday, or I hit return</em>"? Undoubtedly the person in question would not have had the nerve to inflict such a trauma upon you, and was doing it in jest. So you've probably never experienced the worst of such disasters....</p>
<p>It was a quiet Wednesday afternoon. Wednesday, 1st October, 15:15 BST, to be precise, when Peter, an office-mate of mine, leaned away from his terminal and said to me, "<em>Mario, I'm having a little trouble sending mail.</em>" Knowing that msg was capable of confusing even the most capable of people, I sauntered over to his terminal to see what was wrong. A strange error message of the form (I forget the exact details) "<code>cannot access /foo/bar for userid 147</code>" had been issued by msg. My first thought was "<em>Who's userid 147?; the sender of the message, the destination, or what?</em>" So I leant over to another terminal, already logged in, and typed</p>
<div class="highlight"><pre><span></span><code>grep 147 /etc/passwd
</code></pre></div>
<p>only to receive the response</p>
<div class="highlight"><pre><span></span><code>/etc/passwd: No such file or directory.
</code></pre></div>
<p>Instantly, I guessed that something was amiss. This was confirmed when in response to</p>
<div class="highlight"><pre><span></span><code>ls /etc
</code></pre></div>
<p>I got</p>
<div class="highlight"><pre><span></span><code>ls: not found.
</code></pre></div>
<p>I suggested to Peter that it would be a good idea not to try anything for a while, and went off to find our system manager.</p>
<p>When I arrived at his office, his door was ajar, and within ten seconds I realised what the problem was. James, our manager, was sat down, head in hands, hands between knees, as one whose world has just come to an end. Our newly-appointed system programmer, Neil, was beside him, gazing listlessly at the screen of his terminal. And at the top of the screen I spied the following lines:</p>
<div class="highlight"><pre><span></span><code># cd  
# rm -rf *
</code></pre></div>
<p>Oh, shit, I thought. That would just about explain it.</p>
<p>I can't remember what happened in the succeeding minutes; my memory is just a blur. I do remember trying <code>ls</code> (again), <code>ps</code>, who and maybe a few other commands beside, all to no avail. The next thing I remember was being at my terminal again (a multi-window graphics terminal), and typing</p>
<div class="highlight"><pre><span></span><code>cd /  
echo *
</code></pre></div>
<p>I owe a debt of thanks to David Korn for making <code>echo</code> a built-in of his shell; needless to say, <code>/bin</code>, together with<code>/bin/echo</code>, had been deleted. What transpired in the next few minutes was that <code>/dev</code>,<code>/etc</code> and <code>/lib</code> had also gone in their entirety; fortunately Neil had interrupted rm while it was somewhere down below <code>/news</code>, and <code>/tmp</code>, <code>/usr</code>and <code>/users</code> were all untouched.</p>
<p>Meanwhile James had made for our tape cupboard and had retrieved what claimed to be a dump tape of the root filesystem, taken four weeks earlier. The pressing question was, "<em>How do we recover the contents of the tape?</em>". Not only had we lost <code>/etc/restore</code>, but all of the device entries for the tape deck had vanished. And where does <code>mknod</code> live? You guessed it, <code>/etc</code>. How about recovery across Ethernet of any of this from another VAX? Well, /bin/tar had gone, and thoughtfully the Berkeley people had put rcp in <code>/bin</code> in the 4.3 distribution. What's more, none of the Ether stuff wanted to know without <code>/etc/hosts</code> at least. We found a version of <code>cpio</code> in <code>/usr/local</code>, but that was unlikely to do us any good without a tape deck.</p>
<p>Alternatively, we could get the boot tape out and rebuild the root filesystem, but neither James nor Neil had done that before, and we weren't sure that the first thing to happen would be that the whole disk would be re-formatted, losing all our user files. (We take dumps of the user files every Thursday; by Murphy's Law this had to happen on a Wednesday). Another solution might be to borrow a disk from another VAX, boot off that, and tidy up later, but that would have entailed calling the DEC engineer out, at the very least. We had a number of users in the final throes of writing up PhD theses and the loss of a maybe a weeks' work (not to mention the machine down time) was unthinkable.</p>
<p>So, what to do? The next idea was to write a program to make a device descriptor for the tape deck, but we all know where <code>cc</code>, as and <code>ld</code> live. Or maybe make skeletal entries for <code>/etc/passwd</code>, <code>/etc/hosts</code> and so on, so that <code>/usr/bin/ftp</code> would work. By sheer luck, I had a <code>gnuemacs</code> still running in one of my windows, which we could use to create <code>passwd</code>, etc., but the first step was to create a directory to put them in. Of course <code>/bin/mkdir</code> had gone, and so had <code>/bin/mv</code>, so we couldn't rename <code>/tmp</code> to <code>/etc</code>. However, this looked like a reasonable line of attack.</p>
<p>By now we had been joined by Alasdair, our resident UNIX guru, and as luck would have it, someone who knows VAX assembler. So our plan became this: write a program in assembler which would either rename <code>/tmp</code> to <code>/etc</code>, or make <code>/etc</code>, assemble it on another VAX, <code>uuencode</code> it, type in the uuencoded file using my gnu, <code>uudecode</code> it (some bright spark had thought to put <code>uudecode</code> in <code>/usr/bin</code>), run it, and hey presto, it would all be plain sailing from there. By yet another miracle of good fortune, the terminal from which the damage had been done was still <code>su</code>'d to root (su is in <code>/bin</code>, remember?), so at least we stood a chance of all this working.</p>
<p>Off we set on our merry way, and within only an hour we had managed to concoct the dozen or so lines of assembler to create <code>/etc</code>. The stripped binary was only 76 bytes long, so we converted it to hex (slightly more readable than the output of uuencode), and typed it in using my editor. If any of you ever have the same problem, here's the hex for future reference:</p>
<div class="highlight"><pre><span></span><code>070100002c000000000000000000000000000000000000000000000000000000  
0000dd8fff010000dd8f27000000fb02ef07000000fb01ef070000000000bc8f  
8800040000bc012f65746300
</code></pre></div>
<p>I had a handy program around (doesn't everybody?) for converting ASCII hex to binary, and the output of <code>/usr/bin/sum</code> tallied with our original binary. But hang on---how do you set execute permission without <code>/bin/chmod</code>? A few seconds thought (which as usual, lasted a couple of minutes) suggested that we write the binary on top of an already existing binary, owned by me...problem solved. So along we trotted to the terminal with the root login, carefully remembered to set the umask to 0 (so that I could create files in it using my gnu), and ran the binary. So now we had a <code>/etc</code>, writable by all. From there it was but a few easy steps to creating <code>passwd</code>, <code>hosts</code>, <code>services</code>, <code>protocols</code>, (etc), and then <code>ftp</code> was willing to play ball. Then we recovered the contents of /bin across the ether (it's amazing how much you come to miss <code>ls</code> after just a few, short hours), and selected files from <code>/etc</code>. The key file was <code>/etc/rrestore</code>, with which we recovered <code>/dev</code> from the dump tape, and the rest is history.</p>
<p>Now, you're asking yourself (as I am), what's the moral of this story? Well, for one thing, you must always remember the immortal words, <strong>DON'T PANIC</strong>. Our initial reaction was to reboot the machine and try everything as single user, but it's unlikely it would have come up without <code>/etc/init</code> and <code>/bin/sh</code>. Rational thought saved us from this one.</p>
<p>The next thing to remember is that UNIX tools really can be put to unusual purposes. Even without my gnuemacs, we could have survived by using, say, <code>/usr/bin/grep</code> as a substitute for <code>/bin/cat</code>.</p>
<p>And the final thing is, it's amazing how much of the system you can delete without it falling apart completely. Apart from the fact that nobody could login (<code>/bin/login</code>?), and most of the useful commands had gone, everything else seemed normal. Of course, some things can't stand life without say <code>/etc/termcap</code>, or <code>/dev/kmem</code>, or <code>/etc/utmp</code>, but by and large it all hangs together.</p>
<p>I shall leave you with this question: if you were placed in the same situation, and had the presence of mind that always comes with hindsight, could you have got out of it in a simpler or easier way? Answers on a postage stamp to:</p>
<div class="highlight"><pre><span></span><code>Mario Wolczko
------------------------------------------------------------------------
Dept. of Computer Science       ARPA:   miw%uk.ac.man.cs.ux@cs.ucl.ac.uk
The University                  USENET: mcvax!ukc!man.cs.ux!miw
Manchester M13 9PL              JANET:  miw@uk.ac.man.cs.ux
U.K.                            061-273 7121 x 5699
------------------------------------------------------------------------
</code></pre></div></article>
  </main>

  <footer>
    <details>
      <summary>
        <div class="footer-row">
          
          meta
          
          <a href="/recent-changes">recent</a>
          <a href="/rebracketing" class="not-extra-small">random</a>
          <a href="/posts">posts</a>
          <a href="/sitemap" class="not-extra-small">sitemap</a>
          <a href="https://github.dev/zachpmanson/notes/blob/main/./notes/Archive/Folklore/Unix Recovery Legend.md" class="desktop">edit</a>
          <a href="https://github.com/zachpmanson/notes/edit/main/./notes/Archive/Folklore/Unix Recovery Legend.md" class="mobile">edit</a>
          <a href="mailto:zachpmanson@gmail.com?subject=On 'Unix Recovery Legend'">reply</a>
        </div>
      </summary>
      <div class="extra-small">
        <div class="footer-row">
          <a href="/sitemap">sitemap</a>
          <a href="/rebracketing">random</a>
        </div>
      </div>

      

      
      <p>
        

        <span class="backlinks">
          <strong>
            Updated:
          </strong>
          2024-04-04
        </span>

      </p>
    </details>

  </footer>
  
</body>

</html>