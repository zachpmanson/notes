<?xml version='1.0' encoding='UTF-8'?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" version="2.0">
    <channel>
        <title>notes: nextjs</title>
        <link>https://notes.zachmanson.com/nextjs</link>
        <description>Notes tagged #nextjs</description>
        <atom:link href="https://notes.zachmanson.com/nextjs" rel="self" />
        <docs>http://www.rssboard.org/rss-specification</docs>
        <generator>ochrs</generator>
        <image>
            <url>https://zachmanson.com/icons/android-chrome-256x256.png</url>
            <title>notes: nextjs</title>
            <link>https://notes.zachmanson.com/nextjs</link>
        </image>
        <language>en</language>
        <lastBuildDate>Mon, 03 Jun 2024 11:48:08 </lastBuildDate>
        
        <item>
            <title>Vercel Images Optimisation</title>
            <link>https://notes.zachmanson.com/vercel-images-optimisation</link>
            
            <description>A small footgun for beginners using Vercel.</description>
            
            <content:encoded>
                <![CDATA[<p>TLDR: If you are using Vercel and display a lot of images hosted on someone else's server, you probably want to turn off <a href="https://vercel.com/docs/concepts/image-optimization">Image Optimisation</a>.</p>
<p>Over the last week I built <a href="https://alculator.zachmanson.com">Alculator</a> using Next.js and hosted on Vercel. The site uses data lovingly freebooted from the Dan Murphy's public API to rank products by the ratio of price to standard drinks, and displaying this data in a card.</p>
<p><img alt="" src="/media/alculator-cards.png" /></p>
<p>The images for these cards are hosted on a Dan Murphy's server (media.danmurphys.com.au), and I am simply using Next.js <code>&lt;Image&gt;</code> tags to point to them.</p>
<div class="highlight"><pre><span></span><code>...
    &lt;div className=&quot;card center&quot;&gt;
      &lt;div
        className=&quot;flex center-aligned&quot;
        onClick={() =&gt; (window.location.href = `https://www.danmurphys.com.au/product/${item.stockcode}`)}
      &gt;
        &lt;Image
          alt=&quot;Image of drink&quot;
          height=&quot;100&quot;
          width=&quot;80&quot;
          src={`https://media.danmurphys.com.au/dmo/product/${item.stockcode}-1.png`}
        /&gt;
        &lt;div className=&quot;fill-width&quot;&gt;
          &lt;div className=&quot;flex space-between align-center&quot;&gt;
            &lt;h3&gt;{item.name}&lt;/h3&gt;
...
</code></pre></div>
<p>I'm using Vercel's free tier to serve the application which grants 100GB of bandwidth, which is magnitudes higher than any amount of users I expected to serve. I put the finishing touches on the site on December 30th, sent the link to a few people and went to the pub.</p>
<p>Over the next few hours I started receiving strongly worded alerts from Vercel:</p>
<p><img alt="" src="/media/vercel-warnings.png" /></p>
<p>Either I had gone viral or my code was a lot more inefficient than I thought. At 1am I returned home, having reached the Ballmer Peak to diagnose the problem.</p>
<p>On the Vercel/Dashboard/Usage page, right at the bottom is the harmless looking graph titled "Image Optimisations" which turned out to be the culprit. By default, Vercel takes all images hosted in <code>&lt;Image&gt;</code> tags and caches them all at the Edge. Vercel had optimised 1400 of these images before I discovered this and at the free tier this is capped at 1000 images. Whoops.</p>
<p>The solution is simple:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// next-config.js</span>

<span class="cm">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">reactStrictMode</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">unoptimized</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextConfig</span><span class="p">;</span>
</code></pre></div>]]>
            </content:encoded>
            <guid isPermaLink="false">https://notes.zachmanson.com/vercel-images-optimisation</guid>
            <pubDate>2023-01-02</pubDate>
        </item>
        

    </channel>
</rss>