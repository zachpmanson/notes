<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="/_static/styles/global.css" />
  <link rel="stylesheet" href="/_static/styles/code.css" />

  <link rel="icon" href="/_static/icon/favicon.svg" type="image/svg+xml">

  <link rel="alternate" type="application/rss+xml" href="https://notes.zachmanson.com/posts.xml" title="notes: posts" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>notes: xz</title>
</head>

<body>
  <nav>
    <div class="main-icon">
      <a href="/">
        <svg xmlns="http://www.w3.org/2000/svg" baseProfile="full" version="1.1" style="fill: none;"
          viewBox="26.88 56.87 216.25 156.27">
          <path
            style="stroke-width: 15px; stroke-linecap: butt; stroke-linejoin: round; stroke: rgb(10, 10, 10); fill: none;"
            d="M135,75 A60,60 0 0,0 75,135 A60,60 0 0,0 135,195 A60,60 0 0,0 195,135 A60,60 0 0,0 135,75 M45,90 A15,15 0 0,1 60,75 A15,15 0 0,1 75,90 L75,135 L75,180 A15,15 0 0,1 60,195 A15,15 0 0,1 45,180 M225,90 A15,15 0 0,0 210,75 A15,15 0 0,0 195,90 L195,135 L195,180 A15,15 0 0,0 210,195 L210,195 A15,15 0 0,0 225,180 M135,105 A30,30 0 0,1 165,135 A30,30 0 0,1 135,165 A30,30 0 0,1 105,135 A30,30 0 0,1 135,105 M45,105 L45,105 L45,165 M225,105 L225,105 L225,165 ">
          </path>
        </svg>
      </a>
    </div>

    <div class="nav-segments-container">
      <div class="nav-segments">
        
        <div class="nav-links piblings">
          
          
          
          <a href="/databases">Databases</a>
          
          
          
          <a href="/development">Development</a>
          
          
          
          <a href="/exploits" class="activated-link">Exploits</a>
          
          
          
          <a href="/machine-learning">Machine Learning</a>
          
          
          
          <a href="/mistakes">Mistakes</a>
          
          
          
          <a href="/open-source">Open Source</a>
          
          
          
          <a href="/programs">Programs</a>
          
          
          
          <a href="/reverse-engineering">Reverse Engineering</a>
          
          
          
          <a href="/self-hosting">Self-Hosting</a>
          
          
          
          <a href="/software-vs-timezones">Software vs Timezones</a>
          
          
          
          <a href="/terminals">Terminals</a>
          
          
          
          <a href="/testing">Testing</a>
          
          
          
          <a href="/unix">Unix</a>
          
          
        </div>
        

        
        <div class="nav-links siblings">
          
          
          
          <a href="/xz" class="activated-link">XZ</a>
          

          
        </div>
        

        
      </div>
    </div>
  </nav>

  <main>
    <header>
      <h1>The most advanced supply chain attack ever found.</h1>
    </header>

    <article><p>The XZ exploit is a clever supply chain attack, placing a RCE in sshd using a vulnerability in XZ, a compression library that many <a href="/linux">Linux</a> distributions call when running OpenSSH (sshd -&gt; libsystemd (for systemd notifications) -&gt; liblzma (for logging)).  It was discovered by Andres Freund when he noticed that sshd was running with abnormally high CPU usage.</p>
<p>The vulnerability was submitted by Jia Tan, a maintainer of XZ project who had been an active contributor since 2021.   The vulnerability was extremely obfuscated.  <a href="https://www.openwall.com/lists/oss-security/2024/03/29/4">Read the original backdoor report by Andres Freund for more details on this</a>.</p>
<h2 id="maintainers">Maintainers</h2>
<p>There are two maintainers of the XZ projects, Jia Tan and Lasse Collin.  Lasse Collin is the original author of the XZ Utils library, whereas Jia Tan has only been a maintainer since 2022.</p>
<p>Tan appears so have little to no online footprint prior to 2021 when they started making useful contributions to XZ.  It is speculated that Jia Tan is an invented persona.</p>
<blockquote>
<p>He has been part of the xz project for 2 years, adding all sorts of binary test files, and to be honest with this level of sophistication I would be suspicious of even older versions of xz until proven otherwise.</p>
</blockquote>
<p><cite class="standalone"><a href="https://news.ycombinator.com/item?id=39866275">Richard Jones</a></cite></p>
<ul>
<li><a href="https://robmensching.com/blog/posts/2024/03/30/a-microcosm-of-the-interactions-in-open-source-projects/">A Microcosm of the interactions in Open Source projects</a>, and interesting analysis of mailing list discussions about Jia Tan's contributions to the XZ project before Tan was made maintainer</li>
<li><a href="https://tukaani.org/xz-backdoor/">Lasse Collin's page</a> tracking the vulnerability</li>
</ul>
<h2 id="features">Features</h2>
<ul>
<li>kill switch based on <a href="https://piaille.fr/@zeno/112185928685603910">environment variable</a><ul>
<li><code>yolAbejyiejuvnup=Evjtgvsh5okmkAvj</code> is hardcoded (and then obfuscated)</li>
</ul>
</li>
<li>backdoor itself is secured as it checks for a private key<ul>
<li>this is an interesting argument against "when you make a backdoor for good guys you also make a backdoor for bad guys" though that's another conversation entirely</li>
</ul>
</li>
</ul>
<h2 id="oddities">Oddities</h2>
<ul>
<li>In 2022 <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00566.html">there were other suspected sock puppet accounts pushing Collin to introduce new maintainers</a></li>
<li>Tan disabled a function in <a href="https://github.com/google/oss-fuzz/pull/10667">oss-fuzzer</a> in 2023 that the exploit relied on that may have revealed the exploit (<a href="https://social.treehouse.systems/@Aissen/112180302735030319">source</a>)</li>
<li>the day before the exploit was found the xz-java project added a SECURITY.md file </li>
</ul>
<blockquote>
<p>If you discover a security vulnerability in this project please report it privately. <em>Do not disclose it as a public issue.</em> This gives us time to work with you to fix the issue before public exposure, reducing the chance that the exploit will be used before a patch is released.</p>
</blockquote>
<ul>
<li>It disabled Linux landlock?<ul>
<li><a href="https://git.tukaani.org/?p=xz.git;a=blobdiff;f=CMakeLists.txt;h=d2b1af7ab0ab759b6805ced3dff2555e2a4b3f8e;hp=76700591059711e3a4da5b45cf58474dac4e12a7;hb=328c52da8a2bbb81307644efdb58db2c422d9ba7;hpb=eb8ad59e9bab32a8d655796afd39597ea6dcc64d">This commit</a> introduces a syntax error that prevents Linux landlock from being activated.  The test program designed to test if landlock was supported would always fail due to this errant <code>.</code>.</li>
</ul>
</li>
<li>Tan's first GitHub PR is to libarchive and is suspect as it subtly replaces <code>safe_printf</code> calls with unsafe <code>fprintf</code></li>
</ul>
<h2 id="discovery">Discovery</h2>
<blockquote>
<p>I was doing some micro-benchmarking at the time, needed to quiesce the system to reduce noise. Saw sshd processes were using a surprising amount of CPU, despite immediately failing because of wrong usernames etc. Profiled sshd, showing lots of cpu time in liblzma, with perf unable to attribute it to a symbol. Got suspicious. Recalled that I had seen an odd valgrind complaint in automated testing of postgres, a few weeks earlier, after package updates.</p>
<p>Really required a lot of coincidences.</p>
</blockquote>
<p><cite class="standalone"><a href="https://mastodon.social/@AndresFreundTec/112180083704606941">Andres Freund (a Postgres developer at Microsoft)</a></cite></p>
<p>As noted by <a href="https://news.ycombinator.com/item?id=39879960">nurple</a> on HN, this exploit was found for similar reasons to Ken Thompson's supply chain exploit was detected.  Strange performance sparking curiosity.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27">FAQ on the exploit</a> by Sam James</li>
<li><a href="https://news.ycombinator.com/item?id=39865810">Initial discussion on hn</a></li>
<li><a href="https://www.cve.org/CVERecord?id=CVE-2024-3094">CVE-2024-3094 Report</a></li>
<li><a href="https://www.openwall.com/lists/oss-security/2024/03/29/4">Original backdoor report by Freund</a></li>
<li><a href="https://bsky.app/profile/did:plc:x2nsupeeo52oznrmplwapppl/post/3kowjkx2njy2b">Discovery of RCE</a></li>
<li><a href="https://lcamtuf.substack.com/p/technologist-vs-spy-the-xz-backdoor">Technologist vs Spy</a>, making the case that based on the behaviour and circumstances surrounding the bug were that of organised actors</li>
<li><a href="https://github.com/Midar/xz-backdoor-documentation/wiki">XZ Backdoor Documentation</a></li>
<li><a href="https://gynvael.coldwind.pl/?lang=en&amp;id=782">XZ Bash-Stage Obfuscation Explained</a></li>
<li><a href="https://arstechnica.com/security/2024/04/what-we-know-about-the-xz-utils-backdoor-that-almost-infected-the-world/"><strong>Ars Technica Overview</strong></a></li>
<li><a href="https://github.com/amlweems/xzbot">PoC</a> with substituted public key</li>
<li><a href="https://shellsharks.com/xz-compromise-link-roundup">Even more links</a></li>
<li><a href="https://research.swtch.com/xz-timeline">Timeline of XZ</a></li>
<li><a href="https://www.arp242.net/jia-tan-go.html">Jia Tanning Go Code</a></li>
</ul>
<p><img alt="" src="/media/xz-analysis.png" /></p></article>
  </main>

  <footer>
    <details>
      <summary>
        <div class="footer-row">
          
          <date>2024-03-31</date>
          
          <a href="/recent-changes">recent</a>
          <a href="/go" class="not-extra-small">random</a>
          <a href="/posts">posts</a>
          <a href="/sitemap" class="not-extra-small">sitemap</a>
          <a href="mailto:zachpmanson@gmail.com?subject=On 'XZ'">reply</a>
        </div>
      </summary>
      <div class="footer-row">
        <input type="radio" name="theme" id="theme-system" class="invisible" checked>
        <label for="theme-system" class="nonsystem-only"><a>system</a></label>

        <input type="radio" name="theme" id="theme-light" class="invisible">
        <label for="theme-light" class="dark-only"><a>light</a></label>

        <input type="radio" name="theme" id="theme-dark" class="invisible">
        <label for="theme-dark" class="light-only"><a>dark</a></label>
        
          <a href="https://github.dev/zachpmanson/notes/blob/main/./notes/Notes/Software/Exploits/XZ/XZ.md" class="desktop">edit</a>
          <a href="https://github.com/zachpmanson/notes/edit/main/./notes/Notes/Software/Exploits/XZ/XZ.md" class="mobile">edit</a>
          <a href="/sitemap" class="extra-small">sitemap</a>
          <a href="/go" class="extra-small">random</a>
        </div>
      </div>

      

      <p class="backlinks"><strong>Incoming:</strong>
        
        <a href="/exploits">Exploits</a>
        
        <a href="/linux">Linux</a>
        
        <a href="/open-source">Open Source</a>
        
        <a href="/postgres">Postgres</a>
        
        <a href="/put-yourself-in-jia-tans-shoes">Put yourself in Jia Tan's shoes</a>
        
        <a href="/the-future-of-open-source">The Future of Open Source</a>
        
        </span>
      </p>
      

      
      <p class="backlinks"><strong> <a href="/tags">Tags:</a></strong>
        
        <a href="/tags#posts">#posts</a>
        
        </span>
      </p>
      
      <p>
        
        <span class="backlinks">
          <strong>
            Posted:
          </strong>
          <date>2024-03-31</date>

        </span>
        

        <span class="backlinks">
          <strong>
            Updated:
          </strong>
          <date>2024-11-19</date>
        </span>

      </p>
    </details>

  </footer>
  
  <script type="module">
    let allActivatedLinks = document.querySelectorAll(".activated-link");

    function checkVisible(el) {
      let rect = el.getBoundingClientRect();
      let viewHeight = Math.max(document.documentElement.clientHeight, window.innerHeight);
      return !(rect.bottom < 0 || rect.top - viewHeight >= 0);
    }


    function scrollActivatedLinksIntoView(behavior="smooth") {
      for (let link of allActivatedLinks) {
        if (checkVisible(link.parentElement)) {
          link.scrollIntoView({behavior: behavior, block: "center", inline: "nearest"});
        }
      }
    }
    
    document.querySelector("nav").addEventListener("mouseleave", ()=>{
      setTimeout(scrollActivatedLinksIntoView, 350);
    });
    scrollActivatedLinksIntoView();
  </script>
  <script type="module">
      if (localStorage?.getItem("theme") === "dark") {
        document.querySelector("#theme-dark").checked = true;
      } else if (localStorage?.getItem("theme") === "light") {
        document.querySelector("#theme-light").checked = true;
      }

      function setTheme(theme) {
        localStorage.setItem("theme", theme);
      }
      document.querySelectorAll("#theme-system").forEach(el => el.addEventListener("click", () => setTheme(undefined)));
      document.querySelectorAll("#theme-light").forEach(el => el.addEventListener("click", () => setTheme("light")));
      document.querySelectorAll("#theme-dark").forEach(el => el.addEventListener("click", () => setTheme("dark")));
  </script>

</body>

</html>