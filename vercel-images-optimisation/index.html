<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="/_static/styles/global.css" />
  <link rel="stylesheet" href="/_static/styles/code.css" />

  <link rel="icon" href="/_static/icon/icon.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="/_static/icon/favicon.ico" />

  <link rel="alternate" type="application/rss+xml" href="https://notes.zachmanson.com/posts.xml" title="notes: posts" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>notes: vercel images optimisation</title>
</head>

<body>
  <nav>
    <div class="main-icon">
      <a href="/">
        <svg xmlns="http://www.w3.org/2000/svg" baseProfile="full" version="1.1" style="fill: none;"
          viewBox="26.88 56.87 216.25 156.27">
          <path
            style="stroke-width: 15px; stroke-linecap: butt; stroke-linejoin: round; stroke: rgb(10, 10, 10); fill: none;"
            d="M135,75 A60,60 0 0,0 75,135 A60,60 0 0,0 135,195 A60,60 0 0,0 195,135 A60,60 0 0,0 135,75 M45,90 A15,15 0 0,1 60,75 A15,15 0 0,1 75,90 L75,135 L75,180 A15,15 0 0,1 60,195 A15,15 0 0,1 45,180 M225,90 A15,15 0 0,0 210,75 A15,15 0 0,0 195,90 L195,135 L195,180 A15,15 0 0,0 210,195 L210,195 A15,15 0 0,0 225,180 M135,105 A30,30 0 0,1 165,135 A30,30 0 0,1 135,165 A30,30 0 0,1 105,135 A30,30 0 0,1 135,105 M45,105 L45,105 L45,165 M225,105 L225,105 L225,165 ">
          </path>
        </svg>
      </a>
    </div>

    <div class="nav-segments-container">
      <div class="nav-segments">
        
        <div class="nav-links piblings">
          
          
          
          <a href="/bookmarks">Bookmarks</a>
          
          
          
          <a href="/fiction">Fiction</a>
          
          
          
          <a href="/folklore">Folklore</a>
          
          
          
          <a href="/lines">Lines</a>
          
          
          
          <a href="/problems" class="activated-link">Problems</a>
          
          
          
          <a href="/templates">Templates</a>
          
          
        </div>
        

        
        <div class="nav-links siblings">
          
          
          
          <a href="/alembic-revision-collision">Alembic Revision Collision</a>
          

          
          
          <a href="/android-file-transfer-on-macos">Android File Transfer on macOS</a>
          

          
          
          <a href="/automatic-dark-mode">Automatic Dark Mode</a>
          

          
          
          <a href="/avoid-page-breaking-with-wkhtmltopdf">Avoid Page Breaking with wkhtmltopdf</a>
          

          
          
          <a href="/changing-dns-with-systemd">Changing DNS with systemd</a>
          

          
          
          <a href="/cobertura-not-allow-on-gitlab">Cobertura Not Allow on GitLab</a>
          

          
          
          <a href="/command-line-file-sharing">Command Line File Sharing</a>
          

          
          
          <a href="/compressing-videos-for-web">Compressing Videos For Web</a>
          

          
          
          <a href="/cross-component-updates-in-react">Cross Component Updates in React</a>
          

          
          
          <a href="/deploying-docker-from-arm">Deploying Docker From ARM</a>
          

          
          
          <a href="/deploying-elk-on-vercel">Deploying Elk on Vercel</a>
          

          
          
          <a href="/docker-buildx-builder-cant-access-yarn">Docker Buildx Builder Can't Access Yarn</a>
          

          
          
          <a href="/domain-based-link-colours">Domain Based Link Colours</a>
          

          
          
          <a href="/firefox-multi-account-containers-new-tab-behaviour">Firefox Multi-Account Containers New Tab Behaviour</a>
          

          
          
          <a href="/firefox-photon">Firefox Photon</a>
          

          
          
          <a href="/freeze-page-without-mouse">Freeze Page without Mouse</a>
          

          
          
          <a href="/fullscreen-firefox-on-macos">Fullscreen Firefox on macOS</a>
          

          
          
          <a href="/ghidhra-hidpi">Ghidhra HiDPI</a>
          

          
          
          <a href="/git-creation-and-modification-time">Git Creation and Modification Time</a>
          

          
          
          <a href="/git-deleted-branch-recovery">Git Deleted Branch Recovery</a>
          

          
          
          <a href="/git-ignore-changes-to-a-file">Git Ignore Changes to a File</a>
          

          
          
          <a href="/git-repo-contributor-line-count">Git Repo Contributor Line Count</a>
          

          
          
          <a href="/git-restoring-deleted-files-from-past-commits">Git Restoring Deleted Files From Past Commits</a>
          

          
          
          <a href="/git-subdirectory-branch">Git Subdirectory Branch</a>
          

          
          
          <a href="/github-repo-metadata">GitHub Repo Metadata</a>
          

          
          
          <a href="/gmail-vs.-style-tags">Gmail vs. Style Tags</a>
          

          
          
          <a href="/grep-timer">Grep Timer</a>
          

          
          
          <a href="/hacking-sagemcom-router-admin-account">Hacking Sagemcom Router Admin Account</a>
          

          
          
          <a href="/hiding-promoted-jobs-on-linkedin">Hiding Promoted Jobs on LinkedIn</a>
          

          
          
          <a href="/javascript-math-not-defined">JavaScript Math Not Defined</a>
          

          
          
          <a href="/javascript-pretty-printing">JavaScript Pretty Printing</a>
          

          
          
          <a href="/javascript-yyyy-mm-dd-in-local-time">JavaScript YYYY-MM-DD in Local Time</a>
          

          
          
          <a href="/jinja-components">Jinja Components</a>
          

          
          
          <a href="/keychron-fn-keys">Keychron Fn Keys</a>
          

          
          
          <a href="/killing-process-by-port">Killing Process By Port</a>
          

          
          
          <a href="/mui-textfield-border">MUI TextField Border</a>
          

          
          
          <a href="/markdown-in-html">Markdown in HTML</a>
          

          
          
          <a href="/mastodon-domain-alias">Mastodon Domain Alias</a>
          

          
          
          <a href="/minecraft-health-and-death-score-commands">Minecraft Health and Death Score Commands</a>
          

          
          
          <a href="/mocking-functions-in-python">Mocking Functions in Python</a>
          

          
          
          <a href="/next.js-scroll-position-preservation">Next.js Scroll Position Preservation</a>
          

          
          
          <a href="/next.js-with-trpc-and-layouts">Next.js with tRPC and Layouts</a>
          

          
          
          <a href="/nextcloud-aio-occ">Nextcloud AIO occ</a>
          

          
          
          <a href="/nextcloud-phone-photo-upload">Nextcloud Phone Photo Upload</a>
          

          
          
          <a href="/old-pixel-live-wallpapers-on-new-pixels">Old Pixel Live Wallpapers On New Pixels</a>
          

          
          
          <a href="/piping-to-clipboard">Piping to Clipboard</a>
          

          
          
          <a href="/poetry-showing-dependencies-it-refuses-to-install">Poetry Showing Dependencies it Refuses to Install</a>
          

          
          
          <a href="/postgres-in-docker-startup">Postgres in Docker Startup</a>
          

          
          
          <a href="/prisma-schema-changes-and-vercel">Prisma Schema Changes and Vercel</a>
          

          
          
          <a href="/python-freezegun-vs-sqlalchemy">Python Freezegun vs SQLAlchemy</a>
          

          
          
          <a href="/python-total-packages-size">Python Total Packages Size</a>
          

          
          
          <a href="/rtk-query-sending-form-data">RTK Query Sending Form Data</a>
          

          
          
          <a href="/rtk-query-vs.-infinite-scrolling">RTK Query vs. Infinite Scrolling</a>
          

          
          
          <a href="/raw-github-commits">Raw GitHub Commits</a>
          

          
          
          <a href="/react-and-blur()">React and blur()</a>
          

          
          
          <a href="/react-usestate-not-mutating-object">React useState Not Mutating Object</a>
          

          
          
          <a href="/required-arguments-in-typescript-functions">Required Arguments in TypeScript Functions</a>
          

          
          
          <a href="/run-latest-npx-script-version">Run Latest npx Script Version</a>
          

          
          
          <a href="/select-decorator-depreciated">Select Decorator Depreciated</a>
          

          
          
          <a href="/seleniumbasic">SeleniumBasic</a>
          

          
          
          <a href="/self-hosted-postgres-and-prisma">Self-Hosted Postgres and Prisma</a>
          

          
          
          <a href="/sticky-elements">Sticky Elements</a>
          

          
          
          <a href="/ubuntu-server-not-filling-server-disk">Ubuntu Server Not Filling Server DIsk</a>
          

          
          
          <a href="/unique-constraint-in-pgadmin">Unique Constraint in pgAdmin</a>
          

          
          
          <a href="/unlock-prisma-and-postgres">Unlock Prisma and Postgres</a>
          

          
          
          <a href="/update-params-without-scrolling-to-top-in-next.js">Update Params without Scrolling To Top in Next.js</a>
          

          
          
          <a href="/vercel-images-optimisation" class="activated-link">Vercel Images Optimisation</a>
          

          
          
          <a href="/view-deleted-file-in-git">View Deleted File in Git</a>
          

          
          
          <a href="/websockets-vs-nginx">WebSockets vs Nginx</a>
          

          
          
          <a href="/windows-11-without-a-microsoft-account">Windows 11 Without a Microsoft Account</a>
          

          
          
          <a href="/xfce-screentearing">Xfce Screentearing</a>
          

          
          
          <a href="/zod-datestrings">Zod Datestrings</a>
          

          
          
          <a href="/macos-recovery-in-australia">macOS Recovery in Australia</a>
          

          
          
          <a href="/ssh-connection-hanging">ssh Connection Hanging</a>
          

          
          
          <a href="/tmux-system-copying">tmux System Copying</a>
          

          
        </div>
        

        
      </div>
    </div>
  </nav>

  <main>
    <header>
      <h1>A small footgun for beginners using Vercel.</h1>
    </header>

    <article><p>TLDR: If you are using Vercel and display a lot of images hosted on someone else's server, you probably want to turn off <a href="https://vercel.com/docs/concepts/image-optimization">Image Optimisation</a>.</p>
<p>Over the last week I built <a href="https://alculator.zachmanson.com">Alculator</a> using Next.js and hosted on Vercel. The site uses data lovingly freebooted from the Dan Murphy's public API to rank products by the ratio of price to standard drinks, and displaying this data in a card.</p>
<p><img alt="" src="/media/alculator-cards.png" /></p>
<p>The images for these cards are hosted on a Dan Murphy's server (media.danmurphys.com.au), and I am simply using Next.js <code>&lt;Image&gt;</code> tags to point to them.</p>
<div class="highlight"><pre><span></span><code><span class="p">...</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;card center&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex center-aligned&quot;</span>
<span class="w">        </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://www.danmurphys.com.au/product/</span><span class="si">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">stockcode</span><span class="si">}</span><span class="sb">`</span><span class="p">)}</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">          </span><span class="na">alt</span><span class="o">=</span><span class="s">&quot;Image of drink&quot;</span>
<span class="w">          </span><span class="na">height</span><span class="o">=</span><span class="s">&quot;100&quot;</span>
<span class="w">          </span><span class="na">width</span><span class="o">=</span><span class="s">&quot;80&quot;</span>
<span class="w">          </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="sb">`https://media.danmurphys.com.au/dmo/product/</span><span class="si">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">stockcode</span><span class="si">}</span><span class="sb">-1.png`</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;fill-width&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex space-between align-center&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;{</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">...</span>
</code></pre></div>
<p>I'm using Vercel's free tier to serve the application which grants 100GB of bandwidth, which is magnitudes higher than any amount of users I expected to serve. I put the finishing touches on the site on December 30th, sent the link to a few people and went to the pub.</p>
<p>Over the next few hours I started receiving strongly worded alerts from Vercel:</p>
<p><img alt="" src="/media/vercel-warnings.png" /></p>
<p>Either I had gone viral or my code was a lot more inefficient than I thought. At 1am I returned home, having reached the Ballmer Peak to diagnose the problem.</p>
<p>On the Vercel/Dashboard/Usage page, right at the bottom is the harmless looking graph titled "Image Optimisations" which turned out to be the culprit. By default, Vercel takes all images hosted in <code>&lt;Image&gt;</code> tags and caches them all at the Edge. Vercel had optimised 1400 of these images before I discovered this and at the free tier this is capped at 1000 images. Whoops.</p>
<p>The solution is simple:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// next-config.js</span>

<span class="cm">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">reactStrictMode</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">unoptimized</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextConfig</span><span class="p">;</span>
</code></pre></div></article>
  </main>

  <footer>
    <details>
      <summary>
        <div class="footer-row">
          
          <date>2023-01-02</date>
          
          <a href="/recent-changes">recent</a>
          <a href="/next.js" class="not-extra-small">random</a>
          <a href="/posts">posts</a>
          <a href="/sitemap" class="not-extra-small">sitemap</a>
          <a href="https://github.dev/zachpmanson/notes/blob/main/./notes/Archive/Problems/Vercel Images Optimisation.md" class="desktop">edit</a>
          <a href="https://github.com/zachpmanson/notes/edit/main/./notes/Archive/Problems/Vercel Images Optimisation.md" class="mobile">edit</a>
          <a href="mailto:zachpmanson@gmail.com?subject=On 'Vercel Images Optimisation'">reply</a>
        </div>
      </summary>
      <div class="extra-small">
        <div class="footer-row">
          <a href="/sitemap">sitemap</a>
          <a href="/next.js">random</a>
        </div>
      </div>

      

      
      <p class="backlinks"><strong> <a href="/tags">Tags:</a></strong>
        
        <a href="/tags#posts">#posts</a>
        
        </span>
      </p>
      
      <p>
        
        <span class="backlinks">
          <strong>
            Posted:
          </strong>
          <date>2023-01-02</date>

        </span>
        

        <span class="backlinks">
          <strong>
            Updated:
          </strong>
          <date>2024-09-10</date>
        </span>

      </p>
    </details>

  </footer>
  
  <script type="module">
    let allActivatedLinks = document.querySelectorAll(".activated-link");

    function checkVisible(el) {
      let rect = el.getBoundingClientRect();
      let viewHeight = Math.max(document.documentElement.clientHeight, window.innerHeight);
      return !(rect.bottom < 0 || rect.top - viewHeight >= 0);
    }


    function scrollActivatedLinksIntoView(behavior="smooth") {
      for (let link of allActivatedLinks) {
        if (checkVisible(link.parentElement)) {
          link.scrollIntoView({behavior: behavior, block: "center", inline: "nearest"});
        }
      }
    }
    
    document.querySelector("nav").addEventListener("mouseleave", ()=>{
      setTimeout(scrollActivatedLinksIntoView, 350);
    });
    scrollActivatedLinksIntoView();
  </script>
</body>

</html>